#! /bin/bash

set -e
if [ -n "$BUILDPACK_DEBUG" ]; then
  set -x
fi

source $(dirname $0)/../configs.sh

# parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2
LP_DIR=$(
  cd $(dirname $0)
  cd ..
  pwd
)

indent() {
  sed -u 's/^/       /'
}

arrow() {
  sed -u 's/^/-----> /'
}

function mktmpdir() {
  local dir=$1
  rm -rf $dir
  mkdir -p $dir
}

function archive_download() {
  local location="$1"

  mkdir -p $location
  package="$GRAPHICS_MAGICK_ARCHIVE_URL"
  curl $package -s -o - | tar xzf - -C $location --strip-components 1
}

echo "Installing graphicsmagick $GRAPHICS_MAGICK_VERSION" | arrow

# we need this directory, it's our destination
gm_lib_path=$BUILD_DIR/vendor/graphicsmagick
mkdir -p $gm_lib_path

graphicsmagick_cache_dir="${CACHE_DIR}/graphicsmagick-${GRAPHICS_MAGICK_VERSION}-archive"

# Test if cache directory exists
if [ ! -d "$graphicsmagick_cache_dir" ]; then
  # create vendor directories
  mktmpdir $graphicsmagick_cache_dir
fi

# Test if the archive is present in the cache directory then download it if not.
if [ ! -d "${graphicsmagick_cache_dir}/utilities" ]; then
  echo "Downloading archive in $graphicsmagick_cache_dir" | arrow
  archive_download "$graphicsmagick_cache_dir"
fi

# If the archive does not contain the binary, we build it
if [[ ! -f "${graphicsmagick_cache_dir}/utilities/gm" ]]; then
  pushd $graphicsmagick_cache_dir
  ./configure
  make
  make DESTDIR=$gm_lib_path install
  popd
fi

mkdir -p "$BUILD_DIR/bin/"
cp ${graphicsmagick_cache_dir}/utilities/gm "${BUILD_DIR}/bin/"

# If doc folder still exitst, we can delete it safely
if [ -d "${graphicsmagick_cache_dir}/doc" ]; then
  rm -r ${graphicsmagick_tmp_dir}/doc
fi

cp -Rf ${graphicsmagick_cache_dir}/* $gm_lib_path

echo "Building runtime environment for graphicsmagick" | arrow
mkdir -p ${BUILD_DIR}/.profile.d
echo "export PATH=\"\$HOME/bin:\$PATH\"" >${BUILD_DIR}/.profile.d/graphicsmagick.sh

cat <<EOF >export
export PATH=$BUILD_DIR/bin:$PATH
EOF
