#! /bin/bash

set -e
if [ -n "$BUILDPACK_DEBUG" ]; then
  set -x
fi

source $(dirname $0)/../configs.sh

# parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2
LP_DIR=$(
  cd $(dirname $0)
  cd ..
  pwd
)

indent() {
  sed -u 's/^/       /'
}

arrow() {
  sed -u 's/^/-----> /'
}

function mktmpdir() {
  dir=$(mktemp -t graphicsmagick-$1-XXXX)
  rm -rf $dir
  mkdir -p $dir
  echo $dir
}

function archive_download() {
  local location
  location="$1"

  mkdir -p $location
  package="$GRAPHICS_MAGICK_ARCHIVE_URL"
  curl $package -s -o - | tar xzf - -C $location --strip-components 1
}

echo "Installing graphicsmagick $GRAPHICS_MAGICK_VERSION" | arrow

# we need this directory, it's our destination
gm_lib_path=$BUILD_DIR/vendor/graphicsmagick
mkdir -p $gm_lib_path

# vendor directories
graphicsmagick_tmp_dir="$(mktmpdir graphicsmagick)"
archive_download "$graphicsmagick_tmp_dir"

# If the archive does not contain the binary, we build it
if [[ ! -f "${graphicsmagick_tmp_dir}/utilities/gm" ]]; then
  pushd $graphicsmagick_tmp_dir
  ./configure
  make
  make DESTDIR=$gm_lib_path install
  popd
fi

mkdir -p "$BUILD_DIR/bin/"
cp ${graphicsmagick_tmp_dir}/utilities/gm "${BUILD_DIR}/bin/"

rm -rf $VENDORED_GRAPHICSMAGICK/doc
cp -R ${graphicsmagick_tmp_dir}/* $gm_lib_path

echo "Building runtime environment for graphicsmagick" | arrow
mkdir -p ${BUILD_DIR}/.profile.d
echo "export PATH=\"\$HOME/bin:\$PATH\"" >${BUILD_DIR}/.profile.d/graphicsmagick.sh

cat <<EOF >export
export PATH=$BUILD_DIR/bin:$PATH
EOF
