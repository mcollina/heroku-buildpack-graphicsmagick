#! /bin/bash
set -e
if [ -n "$BUILDPACK_DEBUG" ]; then
  set -x
fi

function parse_version() {
  local token="$1"
  local major=0
  local minor=0
  local patch=0

  # Check if it has the correct syntax.
  if egrep '^[0-9]+\.[0-9]+\.[0-9]+' <<<"$token" >/dev/null 2>&1; then
    local n=${token//[!0-9]/ }
    local a=(${n//\./ })
    major=${a[0]}
    minor=${a[1]}
    patch=${a[2]}
  fi

  echo "$major $minor $patch"
}

function mktmpdir() {
  dir=$(mktemp -t graphicsmagick-$1-XXXX)
  rm -rf $dir
  mkdir -p $dir
  echo $dir
}

function archive_download() {
  local url="$1"
  local location="$2"

  mkdir -p $location
  curl $url -s -o - | tar xzf - -C $location --strip-components 1
}

source $(dirname $0)/../configs.sh

pushd $(dirname $0)/.. >>/dev/null
home=$(pwd)
popd >>/dev/null

arr=($(parse_version "$GRAPHICS_MAGICK_VERSION"))
major=${arr[0]}
minor=${arr[1]}
patch=${arr[2]}

if [ "$STACK" == "" ]; then
  echo "must set STACK to the scalingo stack being compiled for (i.e. STACK=scalingo-20)"
  exit 1
fi

basedir="$(cd -P "$(dirname "$0")" && pwd)"

echo ">>> Downloading graphicsmagick"

# vendor directories
vendored_graphicsmagick_dir="$(mktmpdir graphicsmagick)"
archive_download "$VENDOR_GRAPHICS_MAGICK_ARCHIVE_URL" "$vendored_graphicsmagick_dir"
gm_sources=${vendored_graphicsmagick_dir}/graphicsmagick-${GRAPHICS_MAGICK_VERSION}.tar.gz

# curl https://hg.osdn.net/view/graphicsmagick/GM/archive/GraphicsMagick-${major}_${minor}_${patch}.tar.gz >$gm_sources
curl $VENDOR_GRAPHICS_MAGICK_ARCHIVE_URL >$gm_sources
tar -C $vendored_graphicsmagick_dir -x -z -f $gm_sources --strip-components 1

echo ">>> Building graphicsmagick"

# we need this directory, it's our destination
gm_local_path=/tmp/graphicsmagick-${GRAPHICS_MAGICK_VERSION}.tar.gz
gm_lib_path=${BUILD_DIR}/vendor/graphicsmagick
mkdir -p $gm_lib_path

pushd $vendored_graphicsmagick_dir
./configure
make
make DESTDIR=$gm_lib_path install
popd


tar -czf $gm_local_path -C $vendored_graphicsmagick_dir .
echo -e "You can upload archive: $gm_local_path to S3 now: \n\t$gm_local_path"
