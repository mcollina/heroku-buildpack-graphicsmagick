#! /bin/bash
set -e
if [ -n "$BUILDPACK_DEBUG" ]; then
  set -x
fi

function mktmpdir() {
  dir=$(mktemp -t graphicsmagick-$1-XXXX)
  rm -rf $dir
  mkdir -p $dir
  echo $dir
}

function archive_download() {
  local url="$1"
  local location="$2"

  mkdir -p $location
  curl -L $url -s -o - | tar xzf - -C $location --strip-components 1
}

source $(dirname $0)/../configs.sh

if [ "$S3_ACCESS_KEY" == "" ]; then
  echo "must set S3_ACCESS_KEY"
  exit 1
fi

if [ "$S3_SECRET_KEY" == "" ]; then
  echo "must set S3_SECRET_KEY"
  exit 1
fi

if [ "$STACK" == "" ]; then
  echo "must set STACK to the scalingo stack being compiled for (i.e. STACK=scalingo-20)"
  exit 1
fi

pushd $(dirname $0)/.. >>/dev/null
home=$(pwd)
popd >>/dev/null

VENDOR_GRAPHICS_MAGICK_ARCHIVE_URL="${VENDOR_GRAPHICS_MAGICK_ARCHIVE_URL:-"https://sourceforge.net/projects/graphicsmagick/files/graphicsmagick/${GRAPHICS_MAGICK_VERSION}/GraphicsMagick-${GRAPHICS_MAGICK_VERSION}.tar.gz/download"}"

basedir="$(cd -P "$(dirname "$0")" && pwd)"

echo ">>> Downloading graphicsmagick"

# vendor directories
vendored_graphicsmagick_dir="$(mktmpdir graphicsmagick)"
archive_download "$VENDOR_GRAPHICS_MAGICK_ARCHIVE_URL" "$vendored_graphicsmagick_dir"

echo ">>> Building graphicsmagick"

gm_local_path=/tmp/graphicsmagick-${GRAPHICS_MAGICK_VERSION}.tar.gz
gm_lib_path=${BUILD_DIR}/vendor/graphicsmagick
mkdir -p $gm_lib_path

pushd $vendored_graphicsmagick_dir
./configure
make
make DESTDIR=$gm_lib_path install
popd

echo ">>> Creating graphicsmagick archive"

tar -czf $gm_local_path -C $vendored_graphicsmagick_dir .

echo ">>> Uploading graphicsmagick"
echo "    from $gm_local_path file"
${basedir}/lib/upload_buildpack_to_s3.sh "${REMOTE_PATH}" "${gm_local_path}"
